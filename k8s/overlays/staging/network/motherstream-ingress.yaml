apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: motherstream-ingress
  namespace: motherstream
  labels:
    environment: staging
    project: motherstream
  annotations:
    # Disable SSL redirect for staging
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    
    # Development-friendly settings
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    
    # Disable rate limiting for development
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
    # Enable HTTP/2
    nginx.ingress.kubernetes.io/http2-push-preload: "true"
    
    # Disable buffering for streaming
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    
    # CORS headers for streaming
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - staging.motherstream.live
    secretName: staging-motherstream-live-tls
  - hosts:
    - staging.always12.live
    secretName: staging-always12-live-tls
  rules:
  # External staging domains (publicly accessible)
  - host: staging.motherstream.live
    http:
      paths:
      # Statistics endpoint
      - path: /stat
        pathType: Prefix
        backend:
          service:
            name: staging-nginx-rtmp
            port:
              number: 8989
      
      # HLS streaming
      - path: /hls
        pathType: Prefix
        backend:
          service:
            name: staging-nginx-rtmp
            port:
              number: 80
      
      # Frontend (catch-all)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: staging-frontend
            port:
              number: 5173
  
  - host: staging.always12.live
    http:
      paths:
      # Specific API endpoints (matching production)
      - path: /queue-json
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /queue-list
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /timer-page
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /timer-data
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /time-settings
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /block-toggle
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /song-json
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      - path: /song-details
        pathType: Exact
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
              
      # HLS streaming
      - path: /hls
        pathType: Prefix
        backend:
          service:
            name: staging-nginx-rtmp
            port:
              number: 80
      
      # Local static files
      - path: /local
        pathType: Prefix
        backend:
          service:
            name: staging-nginx-rtmp
            port:
              number: 80
      
      # Default backend API (catch-all)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: staging-motherstream
            port:
              number: 8483
