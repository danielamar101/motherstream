apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: motherstream-ingress
  namespace: motherstream
  annotations:
    # Enable SSL redirect
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Enable HTTP/2
    nginx.ingress.kubernetes.io/http2-push-preload: "true"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header Strict-Transport-Security "max-age=31536000" always;
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      
    # WebSocket support
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    
    # Disable buffering for streaming
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    
    # CORS headers for streaming
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - motherstream.live
    secretName: motherstream-live-tls
  - hosts:
    - always12.live
    secretName: always12-live-tls
  rules:
  # motherstream.live domain - Frontend + Backend API
  - host: motherstream.live
    http:
      paths:
      # Backend API routes (specific paths first)
      - path: /backend
        pathType: Prefix
        backend:
          service:
            name: motherstream
            port:
              number: 8483
      
      # Statistics endpoint
      - path: /stat
        pathType: Prefix
        backend:
          service:
            name: nginx-rtmp
            port:
              number: 8989
      
      # HLS streaming
      - path: /hls
        pathType: Prefix
        backend:
          service:
            name: nginx-rtmp
            port:
              number: 80
      
      # Frontend (catch-all, must be last)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 5173
  
  # always12.live domain - Backend API only
  - host: always12.live
    http:
      paths:
      # Specific API endpoints
      - path: /queue-json
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /queue-list
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /timer-page
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /timer-data
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /time-settings
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /block-toggle
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /song-json
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      - path: /song-details
        pathType: Exact
        backend:
          service:
            name: motherstream
            port:
              number: 8483
              
      # Statistics endpoint
      - path: /stat
        pathType: Prefix
        backend:
          service:
            name: nginx-rtmp
            port:
              number: 8989
      
      # HLS streaming
      - path: /hls
        pathType: Prefix
        backend:
          service:
            name: nginx-rtmp
            port:
              number: 80
      
      # Local static files
      - path: /local
        pathType: Prefix
        backend:
          service:
            name: nginx-rtmp
            port:
              number: 80
      
      # Default backend API (catch-all)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: motherstream
            port:
              number: 8483 