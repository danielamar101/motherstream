<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motherstream - Real-Time Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f1e;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #2a2a4a;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-live {
            background: #ef4444;
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-offline {
            background: #6b7280;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a4a;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric {
            margin: 15px 0;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #9ca3af;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric-value.good { color: #10b981; }
        .metric-value.warning { color: #f59e0b; }
        .metric-value.critical { color: #ef4444; }
        
        .metric-unit {
            font-size: 0.5em;
            color: #9ca3af;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #2a2a4a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .progress-fill.good { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-fill.critical { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }
        
        .chart-container-large {
            height: 300px;
        }
        
        .buffer-visualization {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .buffer-segment {
            flex: 1;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        
        .buffer-segment.empty {
            background: #2a2a4a;
            border: 2px dashed #4a4a6a;
        }
        
        .buffer-segment.filling {
            background: linear-gradient(180deg, #3b82f6, #2563eb);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .buffer-segment.full {
            background: linear-gradient(180deg, #10b981, #059669);
        }
        
        .buffer-segment.overflow {
            background: linear-gradient(180deg, #ef4444, #dc2626);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 4px solid #f59e0b;
            color: #fbbf24;
        }
        
        .alert-critical {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
            color: #f87171;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: #2a2a4a;
            padding: 12px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            color: #6b7280;
            font-size: 0.9em;
            border-top: 1px solid #2a2a4a;
            margin-top: 30px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            z-index: 1000;
        }
        
        .connection-status.connected {
            background: #10b981;
            color: white;
        }
        
        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">üîå Connecting...</div>
    
    <div class="container">
        <header>
            <h1>üé• Motherstream Monitor</h1>
            <p style="color: #9ca3af; margin-top: 10px;">Real-Time Stream Performance Dashboard</p>
            <div style="margin-top: 15px;">
                <span class="status-badge" id="streamStatus">‚ö™ OFFLINE</span>
                <span style="margin-left: 15px; color: #9ca3af;" id="streamTime">--:--:--</span>
            </div>
        </header>
        
        <!-- Alerts -->
        <div id="alerts"></div>
        
        <!-- Main Grid -->
        <div class="grid">
            <!-- OBS Performance -->
            <div class="card">
                <h2>üìä OBS Output Performance</h2>
                
                <div class="metric">
                    <div class="metric-label">Active FPS</div>
                    <div class="metric-value" id="fpsValue">
                        <span id="fpsNumber">--</span>
                        <span class="metric-unit">fps</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fpsBar" style="width: 0%;">0%</div>
                    </div>
                </div>
                
                <div class="metric">
                    <div class="metric-label">Encoding Skip Rate</div>
                    <div class="metric-value" id="encodingSkipValue">
                        <span id="encodingSkipNumber">--</span>
                        <span class="metric-unit">fps</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="encodingSkipBar" style="width: 0%;">0%</div>
                    </div>
                </div>
                
                <div class="metric">
                    <div class="metric-label">Frame Render Time</div>
                    <div class="metric-value" id="frameTimeValue">
                        <span id="frameTimeNumber">--</span>
                        <span class="metric-unit">ms</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="frameTimeBar" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- System Resources -->
            <div class="card">
                <h2>üíª System Resources</h2>
                
                <div class="metric">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value" id="cpuValue">
                        <span id="cpuNumber">--</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cpuBar" style="width: 0%;">0%</div>
                    </div>
                </div>
                
                <div class="metric">
                    <div class="metric-label">Memory Usage</div>
                    <div class="metric-value" id="memoryValue">
                        <span id="memoryNumber">--</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="memoryBar" style="width: 0%;">0%</div>
                    </div>
                </div>
                
                <div class="metric">
                    <div class="metric-label">Upload Bandwidth</div>
                    <div class="metric-value" id="bandwidthValue">
                        <span id="bandwidthNumber">--</span>
                        <span class="metric-unit">Mbps</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Buffer Visualization -->
        <div class="card">
            <h2>üì¶ Stream Buffer Visualization</h2>
            <p style="color: #9ca3af; margin-bottom: 15px;">Visual representation of pipeline pressure</p>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Render Pipeline</div>
                    <div class="stat-value" id="renderPressure">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Encoding Queue</div>
                    <div class="stat-value" id="encodingPressure">--</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="metric-label">Render Buffer</div>
                <div class="buffer-visualization" id="renderBuffer">
                    <div class="buffer-segment empty">1</div>
                    <div class="buffer-segment empty">2</div>
                    <div class="buffer-segment empty">3</div>
                    <div class="buffer-segment empty">4</div>
                    <div class="buffer-segment empty">5</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="metric-label">Encoding Buffer</div>
                <div class="buffer-visualization" id="encodingBuffer">
                    <div class="buffer-segment empty">1</div>
                    <div class="buffer-segment empty">2</div>
                    <div class="buffer-segment empty">3</div>
                    <div class="buffer-segment empty">4</div>
                    <div class="buffer-segment empty">5</div>
                </div>
            </div>
            
            <p style="color: #6b7280; font-size: 0.85em; margin-top: 15px;">
                ‚ÑπÔ∏è Buffer levels inferred from performance metrics. Individual source buffers not exposed by OBS WebSocket.
            </p>
        </div>
        
        <!-- Charts -->
        <div class="grid">
            <div class="card">
                <h2>üìà FPS History</h2>
                <div class="chart-container">
                    <canvas id="fpsChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üìà Encoding Skip Rate History</h2>
                <div class="chart-container">
                    <canvas id="skipChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìà System Resources Over Time</h2>
            <div class="chart-container chart-container-large">
                <canvas id="systemChart"></canvas>
            </div>
        </div>
        
        <footer>
            <p>Motherstream Dashboard | Updates every 2 seconds</p>
            <p style="margin-top: 5px;">Configure API endpoint below</p>
        </footer>
    </div>
    
    <script>
        // Configuration - UPDATE THIS with your API endpoint
        const API_BASE_URL = 'http://localhost:8000';  // Change to your server
        
        // Chart.js configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#9ca3af' }
                }
            },
            scales: {
                x: {
                    display: false,
                    grid: { color: '#2a2a4a' }
                },
                y: {
                    grid: { color: '#2a2a4a' },
                    ticks: { color: '#9ca3af' }
                }
            },
            animation: {
                duration: 300
            }
        };
        
        // Initialize charts
        const fpsChart = new Chart(document.getElementById('fpsChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'FPS',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        min: 0,
                        max: 31
                    }
                }
            }
        });
        
        const skipChart = new Chart(document.getElementById('skipChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Encoding Skip Rate (fps)',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        min: 0
                    }
                }
            }
        });
        
        const systemChart = new Chart(document.getElementById('systemChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU %',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Memory %',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Bandwidth (Mbps)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: '#2a2a4a' },
                        ticks: { color: '#9ca3af' },
                        title: { display: true, text: 'CPU / Memory %', color: '#9ca3af' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#9ca3af' },
                        title: { display: true, text: 'Bandwidth (Mbps)', color: '#9ca3af' }
                    }
                }
            }
        });
        
        // Data history
        const maxDataPoints = 60;
        let lastEncodingSkipped = 0;
        let lastNetBytes = 0;
        let lastTime = Date.now();
        
        // Update functions
        function updateMetric(elementId, value, thresholds, unit = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = typeof value === 'number' ? value.toFixed(1) : value;
            
            // Update color class
            const valueDiv = element.closest('.metric-value');
            if (valueDiv) {
                valueDiv.classList.remove('good', 'warning', 'critical');
                if (value < thresholds.warning) {
                    valueDiv.classList.add('good');
                } else if (value < thresholds.critical) {
                    valueDiv.classList.add('warning');
                } else {
                    valueDiv.classList.add('critical');
                }
            }
        }
        
        function updateProgressBar(barId, value, max, thresholds) {
            const bar = document.getElementById(barId);
            if (!bar) return;
            
            const percentage = (value / max) * 100;
            bar.style.width = `${Math.min(percentage, 100)}%`;
            bar.textContent = `${percentage.toFixed(0)}%`;
            
            bar.classList.remove('good', 'warning', 'critical');
            if (value < thresholds.warning) {
                bar.classList.add('good');
            } else if (value < thresholds.critical) {
                bar.classList.add('warning');
            } else {
                bar.classList.add('critical');
            }
        }
        
        function updateBufferVisualization(bufferId, pressure) {
            const container = document.getElementById(bufferId);
            if (!container) return;
            
            const segments = container.querySelectorAll('.buffer-segment');
            const filledCount = Math.floor(pressure * segments.length);
            
            segments.forEach((segment, index) => {
                segment.classList.remove('empty', 'filling', 'full', 'overflow');
                if (index < filledCount - 1) {
                    segment.classList.add('full');
                } else if (index === filledCount - 1) {
                    segment.classList.add('filling');
                } else if (pressure > 0.9 && index === segments.length - 1) {
                    segment.classList.add('overflow');
                } else {
                    segment.classList.add('empty');
                }
            });
        }
        
        function addChartData(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset, i) => {
                dataset.data.push(data[i]);
            });
            
            // Keep only last maxDataPoints
            if (chart.data.labels.length > maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            chart.update('none');
        }
        
        function showAlert(message, type = 'warning') {
            const alertsDiv = document.getElementById('alerts');
            const existingAlert = Array.from(alertsDiv.children).find(
                el => el.textContent.includes(message)
            );
            
            if (existingAlert) return;  // Don't duplicate alerts
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = type === 'critical' ? `üö® ${message}` : `‚ö†Ô∏è ${message}`;
            
            alertsDiv.appendChild(alert);
            
            // Remove after 10 seconds
            setTimeout(() => alert.remove(), 10000);
        }
        
        function clearAlerts() {
            document.getElementById('alerts').innerHTML = '';
        }
        
        async function fetchData() {
            try {
                // This is a mock implementation
                // Replace with actual API calls to your backend
                
                // Example: const response = await fetch(`${API_BASE_URL}/api/monitoring/current`);
                // const data = await response.json();
                
                // Mock data for demonstration
                const currentTime = Date.now();
                const timeDelta = (currentTime - lastTime) / 1000;
                
                const mockData = {
                    obs: {
                        activeFps: 29 + Math.random() * 2,
                        averageFrameRenderTime: 30 + Math.random() * 10,
                        outputSkippedFrames: lastEncodingSkipped + Math.random() * 2,
                        streaming: Math.random() > 0.3,
                        streamTime: Math.floor(Math.random() * 3600)
                    },
                    system: {
                        cpuPercent: 60 + Math.random() * 30,
                        memoryPercent: 50 + Math.random() * 30,
                        networkBytesSent: lastNetBytes + Math.random() * 10000000
                    }
                };
                
                lastTime = currentTime;
                
                // Calculate rates
                const encodingSkipRate = timeDelta > 0 ? 
                    (mockData.obs.outputSkippedFrames - lastEncodingSkipped) / timeDelta : 0;
                lastEncodingSkipped = mockData.obs.outputSkippedFrames;
                
                const bandwidthMbps = timeDelta > 0 ?
                    ((mockData.system.networkBytesSent - lastNetBytes) * 8) / (timeDelta * 1000000) : 0;
                lastNetBytes = mockData.system.networkBytesSent;
                
                // Update connection status
                document.getElementById('connectionStatus').textContent = '‚úÖ Connected';
                document.getElementById('connectionStatus').className = 'connection-status connected';
                
                // Update streaming status
                if (mockData.obs.streaming) {
                    document.getElementById('streamStatus').textContent = 'üî¥ LIVE';
                    document.getElementById('streamStatus').className = 'status-badge status-live';
                    const hours = Math.floor(mockData.obs.streamTime / 3600);
                    const mins = Math.floor((mockData.obs.streamTime % 3600) / 60);
                    const secs = mockData.obs.streamTime % 60;
                    document.getElementById('streamTime').textContent = 
                        `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                } else {
                    document.getElementById('streamStatus').textContent = '‚ö™ OFFLINE';
                    document.getElementById('streamStatus').className = 'status-badge status-offline';
                    document.getElementById('streamTime').textContent = '--:--:--';
                }
                
                // Update OBS metrics
                updateMetric('fpsNumber', mockData.obs.activeFps, { warning: 28, critical: 25 });
                updateProgressBar('fpsBar', mockData.obs.activeFps, 30, { warning: 28, critical: 25 });
                
                updateMetric('encodingSkipNumber', encodingSkipRate, { warning: 1, critical: 5 });
                updateProgressBar('encodingSkipBar', Math.min(encodingSkipRate, 10), 10, { warning: 1, critical: 5 });
                
                updateMetric('frameTimeNumber', mockData.obs.averageFrameRenderTime, { warning: 40, critical: 50 });
                updateProgressBar('frameTimeBar', Math.min(mockData.obs.averageFrameRenderTime, 100), 100, { warning: 40, critical: 50 });
                
                // Update system metrics
                updateMetric('cpuNumber', mockData.system.cpuPercent, { warning: 70, critical: 85 });
                updateProgressBar('cpuBar', mockData.system.cpuPercent, 100, { warning: 70, critical: 85 });
                
                updateMetric('memoryNumber', mockData.system.memoryPercent, { warning: 75, critical: 90 });
                updateProgressBar('memoryBar', mockData.system.memoryPercent, 100, { warning: 75, critical: 90 });
                
                updateMetric('bandwidthNumber', bandwidthMbps, { warning: 800, critical: 900 });
                
                // Update buffer visualizations
                const renderPressure = Math.min(mockData.obs.averageFrameRenderTime / 50, 1);
                const encodingPressure = Math.min(encodingSkipRate / 10, 1);
                
                document.getElementById('renderPressure').textContent = `${(renderPressure * 100).toFixed(0)}%`;
                document.getElementById('encodingPressure').textContent = `${(encodingPressure * 100).toFixed(0)}%`;
                
                updateBufferVisualization('renderBuffer', renderPressure);
                updateBufferVisualization('encodingBuffer', encodingPressure);
                
                // Update charts
                const timeLabel = new Date().toLocaleTimeString();
                addChartData(fpsChart, timeLabel, [mockData.obs.activeFps]);
                addChartData(skipChart, timeLabel, [encodingSkipRate]);
                addChartData(systemChart, timeLabel, [
                    mockData.system.cpuPercent,
                    mockData.system.memoryPercent,
                    bandwidthMbps
                ]);
                
                // Check for issues
                clearAlerts();
                if (encodingSkipRate > 5) {
                    showAlert('CRITICAL: Encoding skip rate very high! Output is choppy.', 'critical');
                } else if (encodingSkipRate > 1) {
                    showAlert('Encoding skip rate elevated. Approaching capacity.', 'warning');
                }
                
                if (mockData.obs.activeFps < 25) {
                    showAlert('CRITICAL: FPS dropped below 25!', 'critical');
                }
                
                if (mockData.system.cpuPercent > 90) {
                    showAlert('CPU usage critical! Consider reducing load.', 'critical');
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('connectionStatus').textContent = '‚ùå Disconnected';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
            }
        }
        
        // Start updating
        fetchData();
        setInterval(fetchData, 2000);  // Update every 2 seconds
        
        console.log('Dashboard initialized. Configure API_BASE_URL at the top of this file to connect to your backend.');
    </script>
</body>
</html>

